pipeline {
    agent any

    stages {
        stage('Deploy via SSH Key') {
            steps {
                script {
                    withCredentials([string(credentialsId: 'RASPI_IP', variable: 'IP')]) {
                        // On utilise le credential SSH qu'on vient de créer
                        sshagent(credentials: ['RASPI_SSH_KEY']) {
                            echo "Déploiement sécurisé sur ${IP}..."
                            sh """
                                ssh -o StrictHostKeyChecking=no ken@${IP} 'mkdir -p ~/ansible_deploy'
                                scp -r ./* ken@${IP}:~/ansible_deploy/
                                ssh ken@${IP} 'cd ~/ansible_deploy && ansible-playbook site.yml -i inventory/hosts.ini'
                            """
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            cleanWs()
        }
    }
}