global
    log stdout format raw local0
    stats socket /tmp/haproxy.stat mode 660 level admin

defaults
    mode http
    log global
    option httplog
    timeout connect 5s
    timeout client  50s
    timeout server  50s

# Annuaire Docker pour la résolution dynamique
resolvers docker_resolver
    nameserver dns1 127.0.0.11:53
    hold valid 10s

frontend http-in
    bind *:80
    
    # Statistiques accessibles via http://IP/haproxy_stats
    stats enable
    stats uri /haproxy_stats
    stats refresh 5s
    
    # Par défaut, on envoie vers Jenkins
    default_backend jenkins_backend

backend jenkins_backend
    # On accepte le 403 de Jenkins comme un signe de vie
    http-check expect status 200-403
    server jenkins_srv jenkins:8080 check resolvers docker_resolver init-addr last,libc,none
