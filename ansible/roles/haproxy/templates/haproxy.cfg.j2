global
    log stdout format raw local0
    stats socket /tmp/haproxy.stat mode 660 level admin
    stats timeout 30s

defaults
    log global
    mode http
    option httplog
    timeout connect 10s
    timeout client  1m
    timeout server  1m

# Annuaire interne Docker pour la résolution de noms
resolvers docker_resolver
    nameserver dns1 127.0.0.11:53
    resolve_retries 3
    hold valid 10s

frontend http-in
    bind *:80
    
    # Statistiques HAProxy
    acl is_stats path_beg /stats
    use_backend stats_backend if is_stats

    # Routage vers Jenkins (via domaine)
    acl is_jenkins hdr(host) -i jenkins.local
    use_backend jenkins_backend if is_jenkins
    
    # Par défaut, on envoie vers Jenkins pour le test IP directe
    default_backend jenkins_backend

backend jenkins_backend
    # On accepte les codes 200 à 403 comme étant "Sains" pour Jenkins
    http-check expect status 200-403
    server jenkins_srv jenkins:8080 check resolvers docker_resolver init-addr last,libc,none

backend stats_backend
    stats enable
    stats uri /stats
    stats refresh 10s
